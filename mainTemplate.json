{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"userAssignedIdentity": {
			"type": "string",
			"metadata": {
				"description": "User-assigned identity for resource group"
			}
		},
		"wlsShiphomeURL": {
			"type": "string",
			"metadata": {
				"description": "Provide Oracle WebLoic shiphome SAS URI"
			}
		},
		"jdkURL": {
			"type": "string",
			"metadata": {
				"description": "Provide JDK SAS URI"
			}
		},
		"wlsVersion": {
			"type": "string",
			"metadata": {
				"description": "Provide WebLogic version"
			}
		},
		"jdkVersion": {
			"type": "string",
			"metadata": {
				"description": "Provide JDK version"
			}
		},
		"acceptOTNLicenseAgreement": {
			"type": "string",
			"metadata": {
				"description": "Do you agree to provide OTN credentials to accept OTN License Agreement? Enter Y or y to agree, else N or n"
			}
		},
		"otnAccountUsername": {
			"type": "string",
			"metadata": {
				"description": "Username for your Oracle Technology Network account"
			}
		},
		"otnAccountPassword": {
			"type": "securestring",
			"metadata": {
				"description": "Password for your Oracle Technology Network account"
			}
		},
		"linuxOSVersion": {
			"type": "string",
			"defaultValue": "7.6",
			"allowedValues": [
				"7.6",
				"7.4",
				"7.3"
			],
			"metadata": {
				"description": "The Oracle Linux version for the VM. This will pick a fully patched image of this given Oracle Linux version."
			}
		},
		"location": {
			"type": "string",
			"defaultValue": "[resourceGroup().location]",
			"metadata": {
				"description": "Location for all resources."
			}
		}
	},
	"variables": {
		"name_imageTemplate": "[concat('wls',parameters('wlsVersion'),'-',parameters('jdkVersion'),'-ol',parameters('linuxOSVersion'))]",
		"name_imagebuilderTemplate": "[concat('wls',parameters('wlsVersion'),'-',parameters('jdkVersion'),'-ol',parameters('linuxOSVersion'))]",
		"name_scriptCommand": "[concat('sh setupWLS.sh',' <<< \"',parameters('acceptOTNLicenseAgreement'),' ',parameters('otnAccountUsername'),' ',parameters('otnAccountPassword'),' ',parameters('wlsShiphomeURL'),' ',parameters('jdkURL'),' ',parameters('wlsVersion'),' ',parameters('jdkVersion'),'\"')]"
	},
	"resources": [
		{
			"name": "[variables('name_imageTemplate')]",
			"type": "Microsoft.VirtualMachineImages/imageTemplates",
			"apiVersion": "2019-05-01-preview",
			"location": "[parameters('location')]",
			"dependsOn": [
			],
			"tags": {
				"imagebuilderTemplate": "[variables('name_imagebuilderTemplate')]",
				"userIdentity": "enabled"
			},
			"identity": {
				"type": "UserAssigned",
				"userAssignedIdentities": {
					"[parameters('userAssignedIdentity')]": {
					}
				}
			},
			"properties": {
				"source": {
					"type": "PlatformImage",
					"publisher": "Oracle",
					"offer": "Oracle-Linux",
					"sku": "[parameters('linuxOSVersion')]",
					"version": "latest"
				},
				"customize": [
					{
						"type": "Shell",
						"name": "setupWLS",
						"expect_disconnect": true,
						"inline": [	"mkdir -p /u01/scripts cd /u01/scripts",
									"cd /u01/scripts",
									"wget https://raw.githubusercontent.com/sanjaymantoor/wls-image-builder/master/setupWLS.sh",
									"[variables('name_scriptCommand')]",
									"sudo reboot",
									"cat /etc/os-release"
								]
					}
				],

				"distribute": [
					{
						"type": "VHD",
						"runOutputName": "wlsOL7.6"
					}
				]
			}
		}
	]
}
